#!/bin/bash

# å…¨å±€é…ç½®
CONFIG_DIR="/etc/waywrapper"
CONFIG_FILE="$CONFIG_DIR/binaries.conf"

# æ£€æŸ¥æ˜¯å¦ä»¥ root è¿è¡Œï¼ˆå†™ç³»ç»Ÿæ–‡ä»¶éœ€è¦æƒé™ï¼‰
require_sudo_or_root() {
    if [[ $EUID -ne 0 ]]; then
        echo "Error: This script requires root privileges to manage global binaries." >&2
        echo "Please run with sudo." >&2
        exit 1
    fi
}

# æ˜¾ç¤ºå¸®åŠ©
show_help() {
    cat << 'EOF'
waywrapper - Wayland wrapper manager for binaries

Usage:
  waywrapper --set-binary-path /path/to/binary
  waywrapper --remove-binary-path /path/to/binary
  waywrapper --update [--dry-run] [--force]
  waywrapper --list
  waywrapper --help | -h

Options:
  --set-binary-path PATH     Register a binary for Wayland wrapping
  --remove-binary-path PATH  Unregister a binary
  --update                   Apply wrapper scripts to registered binaries
  --update --dry-run         Simulate update (no changes made)
  --update --force           Re-wrap even if already wrapped
  --list                     List all registered binaries
  --help, -h                 Show this help message

Notes:
  - Must run with sudo for --set-binary-path, --remove-binary-path, and --update.
  - Original binary is saved as <binary>.orig.
  - Wrapper adds: --ozone-platform-hint=wayland
EOF
}

# æ£€æŸ¥æ˜¯å¦æ˜¯ wrapper è„šæœ¬
is_wrapper_script() {
    local file="$1"
    [[ -f "$file" ]] || return 1
    head -n 5 "$file" 2>/dev/null | grep -q "IsWrapper=true"
}

# æ³¨å†ŒäºŒè¿›åˆ¶
set_binary_path() {
    local path="$1"
    if [[ ! -f "$path" ]]; then
        echo "Error: Binary not found: $path" >&2
        exit 1
    fi

    mkdir -p "$CONFIG_DIR"
    touch "$CONFIG_FILE"

    if grep -Fxq "$path" "$CONFIG_FILE" 2>/dev/null; then
        echo "Already registered: $path"
    else
        echo "$path" >> "$CONFIG_FILE"
        echo "Registered: $path"
    fi
}

# ç§»é™¤å·²æ³¨å†Œçš„äºŒè¿›åˆ¶
remove_binary_path() {
    local path="$1"
    if grep -Fxq "$path" "$CONFIG_FILE" 2>/dev/null; then
        sed -i "\|$path|d" "$CONFIG_FILE"
        echo "Removed from registry: $path"
    else
        echo "Not found in registry: $path"
    fi
}

# åˆ—å‡ºæ‰€æœ‰æ³¨å†Œçš„äºŒè¿›åˆ¶
list_binaries() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No binaries registered."
        return 0
    fi

    echo "Registered binaries:"
    grep -v '^$' "$CONFIG_FILE" | while IFS= read -r bin; do
        if [[ -n "$bin" ]]; then
            local status="not exists"
            if [[ -f "$bin" ]]; then
                if is_wrapper_script "$bin"; then
                    status="wrapped"
                else
                    status="raw binary (not wrapped)"
                fi
            elif [[ -f "$bin.orig" ]]; then
                status="original exists (.orig)"
            fi
            printf "  %s (%s)\n" "$bin" "$status"
        fi
    done
}

create_wrapper_script() {
    local wrapper_path="$1"
    local orig_path="$2"

    cat > "$wrapper_path" << 'EOF'
#!/bin/bash
# waywrapper: Wrapper script to enable Wayland via Ozone
IsWrapper=true

# Resolve the absolute path of the original binary
ORIG_BINARY="$(readlink -f "$0").orig"

# Safety check: ensure .orig file exists
if [[ ! -f "$ORIG_BINARY" ]]; then
    echo "âŒ waywrapper: Critical error - original binary missing:" >&2
    echo "    $ORIG_BINARY" >&2
    echo "ðŸ’¡ Run 'sudo waywrapper --update' to fix, or restore manually." >&2
    exit 1
fi

# Enable Wayland by default
exec "$ORIG_BINARY" --ozone-platform-hint=wayland "$@"
EOF

    # æ¢å¤æƒé™ï¼ˆå‚è€ƒ .origï¼‰
    if [[ -f "$orig_path" ]]; then
        chmod --reference="$orig_path" "$wrapper_path" 2>/dev/null || chmod +x "$wrapper_path"
    else
        chmod +x "$wrapper_path"
    fi
}

update_binaries() {
    local dry_run=false
    local force=false

    # è§£æžé€‰é¡¹
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --dry-run)
                dry_run=true
                shift
                ;;
            --force)
                force=true
                shift
                ;;
            *)
                break
                ;;
        esac
    done

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "No binaries registered. Use --set-binary-path first."
        return 0
    fi

    local total=0
    local skipped=0
    local processed=0
    local repaired=0

    while IFS= read -r binary_path; do
        [[ -z "$binary_path" ]] && continue
        ((total++))

        if [[ ! -f "$binary_path" ]]; then
            echo "âš ï¸  Binary not found: $binary_path"
            continue
        fi

        local orig_path="$binary_path.orig"

        # åˆ¤æ–­æ˜¯å¦å·²ç»æ˜¯ wrapper è„šæœ¬
        if is_wrapper_script "$binary_path"; then
            if [[ "$force" != true ]] && [[ "$dry_run" != true ]]; then
                echo "â­ï¸  Skipping (already wrapped): $binary_path"
                ((skipped++))
                continue
            fi

            # å¼ºåˆ¶æ›´æ–°æˆ– dry-run æ¨¡å¼
            if [[ "$dry_run" == true ]]; then
                echo "ðŸ“ Would re-wrap (update wrapper): $binary_path"
                ((processed++))
                continue
            fi

            # æ£€æŸ¥ .orig æ˜¯å¦å­˜åœ¨
            if [[ ! -f "$orig_path" ]]; then
                echo "âŒ Wrapper exists but original backup missing: $orig_path"
                echo "ðŸ’¡ Cannot restore. Skipping: $binary_path"
                continue
            fi

            # åˆ é™¤æ—§ wrapperï¼Œç›´æŽ¥é‡å»º
            rm -f "$binary_path"
            echo "ðŸ”§ Removed old wrapper: $binary_path"

            # åˆ›å»ºæ–° wrapper
            create_wrapper_script "$binary_path" "$orig_path"
            echo "âœ¨ Updated wrapper: $binary_path"
            ((repaired++))
            continue
        fi

        # ä¸æ˜¯ wrapper è„šæœ¬ï¼šæ‰§è¡Œæ ‡å‡†åŒ…è£…æµç¨‹

        if [[ "$dry_run" == true ]]; then
            echo "ðŸ“ Would wrap (new): $binary_path"
            ((processed++))
            continue
        fi

        # æ£€æŸ¥ .orig æ˜¯å¦å·²å­˜åœ¨ï¼ˆé˜²æ­¢è¦†ç›–çœŸå®žæ•°æ®ï¼‰
        if [[ -f "$orig_path" ]]; then
            echo "âš ï¸  Backup already exists: $orig_path"
            echo "    This may be left over from a failed setup."
            if [[ "$force" == true ]]; then
                echo "    --force used: proceeding to rebuild wrapper."
                rm -f "$binary_path"  # åªåˆ  wrapperï¼Œä¸ç¢° .orig
                create_wrapper_script "$binary_path" "$orig_path"
                echo "âœ¨ Rebuilt wrapper (missing): $binary_path"
                ((repaired++))
            else
                echo "    Skipping. Use --force to rebuild wrapper."
                ((skipped++))
            fi
            continue
        fi

        # æ ‡å‡†æµç¨‹ï¼šé‡å‘½å + åˆ›å»º wrapper
        if mv "$binary_path" "$orig_path"; then
            echo "ðŸ“¦ Renamed to backup: $binary_path -> $orig_path"
        else
            echo "âŒ Failed to rename: $binary_path" >&2
            continue
        fi

        create_wrapper_script "$binary_path" "$orig_path"
        echo "âœ¨ Created wrapper: $binary_path"
        ((processed++))
    done < "$CONFIG_FILE"

    # æ±‡æ€»
    echo "---"
    echo "Summary: $total total"
    echo "         $processed new wrapped, $repaired updated, $skipped skipped"
    if [[ "$dry_run" == true ]]; then
        echo "(Dry run mode: no changes were made)"
    fi
}

# ä¸»å‡½æ•°
main() {
    # è‡³å°‘ä¸€ä¸ªå‚æ•°
    [[ $# -eq 0 ]] && show_help && exit 1

    case "$1" in
        --set-binary-path)
            require_sudo_or_root
            if [[ -z "$2" ]]; then
                echo "Error: Missing path for --set-binary-path" >&2
                exit 1
            fi
            set_binary_path "$2"
            ;;

        --remove-binary-path)
            require_sudo_or_root
            if [[ -z "$2" ]]; then
                echo "Error: Missing path for --remove-binary-path" >&2
                exit 1
            fi
            remove_binary_path "$2"
            ;;

        --list)
            if [[ -f "$CONFIG_FILE" ]]; then
                list_binaries
            else
                echo "No binaries registered."
            fi
            ;;

        --update)
            require_sudo_or_root
            shift
            update_binaries "$@"
            ;;

        --help|-h)
            show_help
            ;;

        *)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage." >&2
            exit 1
            ;;
    esac
}

# æ‰§è¡Œ
main "$@"
